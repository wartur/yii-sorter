YII-SORTER ([Русская версия](https://github.com/wartur/yii-sorter/blob/master/README.ru.md))
============================================================================================

Extension for Yii to work with an ordered list of user controlled. When using this extension do not forget to use table locks or transactions.

DEMO: http://yii-sorter.wartur.ru

[Description of the algorithm](https://github.com/wartur/yii-sorter/blob/master/ALGORITHM.md)

## Release 1.0.0 for Yii first and last. Further development [to be carried out on Yii2](https://github.com/wartur/yii2-sorter)

###### From the author
> This extension was created for fun and to meet their vile,
> vulgar and useless in practice, perfectionism, I am aware
> that this problem can be solved optimally less and much
> less time consuming. I tried to create the most convenient,
> fast and stable mechanism for solving simple enough and often
> enough in their practice tasks

Abstract
--------
Extension allows you to work with an ordered list generated by the user.
Extension provides the highest speed of the database.
To insert a record in any place ordered list requires a write request to the database.

Examples of use: display order of articles on the page, the widgets on the screen.
Due to the algorithm used, this extension is useful for working
with very large data sets that can not fit in memory.

The extension is as a component of the application
behavior for CActiveRecord and a set of ready-made widgets and actions to work with him.

Component is used to support functional lighting records
as a link between the display and CActiveRecord

Working with records occurs in full accordance with the concept
of ActiveRecord. Extension does not use direct calls to the database
to record. So you can not worry about the performance of
beforeSave, afterSave. All your events over the records will
work without errors, including those that have been changed indirectly.

The algorithm is tested with the default settings. It has been tested in
some extreme conditions and settings other than the default settings.
Code coverage of more than 98% (actually 92% - 6% do not cover non-critical
section of code that is required only when the project development
and helps the developer). For data integrity, do not worry IN COMPLIANCE
work through transaction / lock or using this extension action.

IMPORTANT: all operations using this extension shall be made through the
transaction (ISOLATION LEVEL SERIALIZABLE) / lock. Otherwise, there is a
possibility of destruction of the database. All actions of this expansion
include transactions in cases when the table does not support transactions
in the component you want to specify that you want to use a table lock.

Connecting to the expansion project
-----------------------------------
1) [Download the latest release](https://github.com/wartur/yii-sorter/releases)

2) Распакуйте yii-sorter в директории ext.wartur.yii-sorter

3) Добавьте новый алиас пути в начало конфигурационного файла (по умолчанию: config/main.php)
```php
Yii::setPathOfAlias('sorter', 'protected/extensions/wartur/yii-sorter');
```

4) Добавьте новый компонент приложения в конфигурационный файл.
Минимальная конфигурация:
```php
'components'=>array(
	'sorter' => array(
		'class' => 'sorter.components.Sorter',
	),
	// ....
)
```

5) Добавьте поведение в модель в которой требуется использовать упорядоченный список.
Минимальная конфигурация:
```php
public function behaviors() {
	return array_merge(parent::behaviors(), array(
		'SorterActiveRecordBehavior' => array(
			'class' => 'sorter.behaviors.SorterActiveRecordBehavior',
		)
	));
}
```

6) Проверьте, что ваша модель удовлетворяет схеме, указанной в [sorter.tests.env.schema](https://github.com/wartur/yii-sorter/blob/master/tests/env/schema/sortest.sql).
Помните для работы поведения требуется поле SIGNED INT sort с УНИКАЛЬНЫМ ключом. Подробнее
вы можете прочитать в [API reference поведения](https://github.com/wartur/yii-sorter/blob/master/behaviors/SorterActiveRecordBehavior.php)

Работа с готовыми виджетами
---------------------------
К расширению поставляется базовый набор виджетов.
Используя текущее API, вы можете написать свой виджет, остальное за вас
сделает поведение. Вам не нужно знать, как оно сработает на низком уровне, важно
понимать, что оно сработает очень быстро и правильно.

1) Добавьте к таблице CGridView колонку с простым интерфейсом управления позициями.
Минимальная конфигурация:
```php
<?php
$this->widget('zii.widgets.grid.CGridView', array(
	'dataProvider' => $model->search(),
	'columns' => array(
		'id',
		array(
			'class' => 'sorter.widgets.SorterButtonColumn',
		),
	)
));
?>
```

2) Добавьте к таблице колонку для перемещения текущей строки перед определенной позицией.
Минимальная конфигурация:
```php
<?php
$this->widget('zii.widgets.grid.CGridView', array(
	'dataProvider' => $model->search(),
	'columns' => array(
		'id',
		array(
			'class' => 'sorter.widgets.SorterDropDownColumn',
		),
	)
));
?>
```

3) Для работы виджетов с контроллером, вам требуется добавить в контроллер
действия и поведение. Поведение обеспечивает связь контроллера с моделью.
Полный набор действий являются полной имплиментацией API поведения
```php
public function actions() {
	return array_merge(parent::actions(), array(
		'sorterMoveNumber' => 'sorter.actions.SorterMoveNumberAction',
		'sorterMoveOne' => 'sorter.actions.SorterMoveOneAction',
		'sorterMoveToEdge' => 'sorter.actions.SorterMoveToEdgeAction',
		'sorterMoveToModel' => 'sorter.actions.SorterMoveToModelAction',
		'sorterMoveToPosition' => 'sorter.actions.SorterMoveToPositionAction',
	));
}

public function behaviors() {
	return array_merge(parent::behaviors(), array(
		'SorterControllerBehavior' => array(
			'class' => 'sorter.behaviors.SorterControllerBehavior',
			'className' => 'Sortest',
		),
	));
}
```

Подробнее об этих виджетах вы можете прочитать в API reference
в директории [sorter.widgets](https://github.com/wartur/yii-sorter/tree/master/widgets),
у них есть дополнительные параметры настройки

Работа с подсветкой-вспышкой
----------------------------
Для подключения подсветки требуется в конфигурационном файле
в конфигурации компонента добавить параметр useFlashHighligh.
Данная настройка указывает компоненту на то, что требуется сохранять данные
об операциях над моделями для последующего принятия решения о подсветке
```php
'components'=>array(
	'sorter' => array(
		'class' => 'sorter.components.Sorter',
		'useFlashHighligh' => true
	),
	// ....
)
```

Подсветка выполнена в качестве методов хелперов для настройки CGvidView.
Минимальная конфигурация:
```php
<?php
$this->widget('zii.widgets.grid.CGridView', array(
	'dataProvider' => $model->search(),
	'rowHtmlOptionsExpression' => 'Yii::app()->sorter->fhGridRowHtmlOptionsExpression($data)',
	'afterAjaxUpdate' => Yii::app()->sorter->fhGridAfterUpdateCode(true),
	'columns' => array(
		'id',
		array(
			'class' => 'sorter.widgets.SorterButtonColumn',
		),
	)
));
?>
```

У хелперов Sorter::fhGridRowHtmlOptionsExpression и Sorter::fhGridAfterUpdateCode
есть дополнительные параметры кастомизации, подробнее в [API reference](https://github.com/wartur/yii-sorter/blob/master/components/Sorter.php)
данных методов

Используя дополнительные настройки хелперов компонента Sorter, вы сможете вместо вспышки
использовать выделение selected встроенное в yii. Для этого надо поменять
используемый параметр Sorter::$flashHighlightCssClass = 'selected'. В этом случае
afterAjaxUpdate задавать не требуется.

Обеспечение целостности на таблицах, не поддерживающие транзакции
-----------------------------------------------------------------
Действия имплементированы с использованием транзакций с максимальной изоляцией.
В некоторых случаях транзакцию выполнить невозможно. Из-за этого приходится
пользоваться блокированием таблицы целиком. В готовых действиях уже все имплементировано,
вам требуется только добавить в конфигурационном файле в конфигурацию компонента
соответствующую настройку:
```php
'components'=>array(
	'sorter' => array(
		'class' => 'sorter.components.Sorter',
		'useLockTable' => true
	),
	// ....
)
```

Отладочная информация. Для фанатов подкапотного пространства
---------------------
Можно добавить данную колонку и посмотреть как перемещаются биты или изменяюся натуральные величины поля sort =)
```php
'columns' => array(
	array(
		'type' => 'raw',
		'name' => 'sort',
		'value' => '"(".str_pad(decbin($data->sort), 32, "0", STR_PAD_LEFT).")<br>".$data->sort'
	),
	// ...
)
```

Удачной работы!


(Sorry for my english)
